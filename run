#!/usr/bin/env ruby
require 'cinch'
require 'nokogiri'
require 'open-uri'

def action
  bot = Cinch::Bot.new do
    configure do |c|
      c.nick = '김젼봇'
      c.realname = 'love'
      c.user = 'slavery'

      c.server = 'irc.uriirc.org'
      c.port = 16667
      c.ssl.use = true

      c.channels = ['#hyeon']
      c.max_reconnect_delay = 60
    end

    on :message, '스트릭' do |m|
      doc = Nokogiri::HTML(open('https://github.com/simnalamburt'))
      text = doc.at_css('#contributions-calendar .contrib-column:last span.contrib-number').content

      # ex) 15 days
      m.reply text
    end

    on :message, 'ㅇㅅㅇ)b' do |m|
      m.reply 'd(ㅇㅅㅇ'
    end

    on :message, '>ㅅㅇ' do |m|
      m.reply 'ㅇㅅ<'
    end
  end

  bot.start
end

unless ARGV == ['production']
  trap 'SIGINT' do
    puts ''
    puts 'Bye!'
    puts ''
    exit
  end

  action
else
  loop do
    begin
      action
    rescue Exception => msg
      puts ''
      puts ''
      puts '오직 죽음만이 나를 멈출 수 있다'
      puts ''
      puts msg
      puts ''
      puts ''
    end
  end
end
